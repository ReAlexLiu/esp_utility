<!DOCTYPE html>
<html>
<head>
    <title>控制中心</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .progress-bar {
            transition: width 0.3s ease;
        }
        .control-card, .flash-card {
            transition: all 0.2s ease;
        }
        .control-card:hover, .flash-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        .sensor-row, .network-row {
            transition: all 0.2s ease;
        }
        .sensor-row:hover, .network-row:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .network-row.selected {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-connected {
            background-color: #10b981; /* 绿色 */
        }
        .status-disconnected {
            background-color: #ef4444; /* 红色 */
        }
        .status-scanning {
            background-color: #f59e0b; /* 黄色 */
        }
        .signal-strength {
            display: flex;
            align-items: center;
        }
        .signal-bar {
            width: 3px;
            margin: 0 1px;
            background-color: #9ca3af;
            border-radius: 1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab-button.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="container mx-auto px-4 py-8 max-w-3xl">
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <!-- 顶部标签栏 -->
        <div class="border-b border-gray-200">
            <div class="flex flex-wrap">
                <div class="tab-button active px-6 py-4 text-gray-700" data-tab="wifi">WiFi配置</div>
                <div class="tab-button px-6 py-4 text-gray-700" data-tab="ds18b20">DS18B20配置</div>
                <div class="tab-button px-6 py-4 text-gray-700" data-tab="fan">风扇配置</div>
                <div class="tab-button px-6 py-4 text-gray-700" data-tab="time">时钟/时间设置</div>
                <div class="tab-button px-6 py-4 text-gray-700" data-tab="ota">OTA更新</div>
            </div>
        </div>

        <!-- WiFi配置标签内容 -->
        <div id="wifi-content" class="tab-content active p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-center text-blue-600 w-full">WiFi 配网设置</h1>
            </div>

            <!-- 配置说明卡片 -->
            <div class="flash-card bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6 transition-all duration-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">网络配置</h2>
                <p class="text-sm text-gray-600">
                    请从列表中选择您要连接的WiFi网络，输入密码后点击连接按钮。设备将保存配置并尝试连接到指定网络。
                    <span id="device-status" class="inline-flex items-center ml-2">
                            <span class="status-indicator status-scanning"></span>
                            <span>等待配置</span>
                        </span>
                </p>
            </div>

            <!-- 网络扫描和配置区域 -->
            <form id="wifiForm" class="space-y-6">
                <!-- 扫描按钮 -->
                <div class="mb-4">
                    <button type="button" id="scanBtn"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                        <i class="fa fa-search mr-2"></i> 扫描附近WiFi网络
                    </button>
                </div>

                <!-- 网络列表 -->
                <div class="overflow-x-auto mb-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                        <tr>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">
                                WiFi名称 (SSID)
                            </th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                信号强度
                            </th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">
                                加密方式
                            </th>
                        </tr>
                        </thead>
                        <tbody id="networksList" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                                <i class="fa fa-wifi mr-2"></i>点击扫描按钮获取附近WiFi网络
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 选中的网络和密码输入 -->
                <div id="networkConfig" class="space-y-4 hidden">
                    <div>
                        <label for="selectedSsid"
                               class="block text-sm font-medium text-gray-700 mb-1">选中的网络</label>
                        <input type="text" id="selectedSsid" name="ssid" readonly
                               class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm bg-gray-50">
                    </div>

                    <div>
                        <label for="wifiPassword" class="block text-sm font-medium text-gray-700 mb-1">WiFi密码</label>
                        <input type="password" id="wifiPassword" name="password" autocomplete="new-password"
                               class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <p class="mt-1 text-xs text-gray-500">如果网络没有密码，请留空</p>
                    </div>
                </div>

                <div class="flex space-x-4 pt-2">
                    <button type="submit" id="connectBtn"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center"
                            disabled>
                        <i class="fa fa-wifi mr-2"></i> 连接网络
                    </button>
                    <button type="button" id="resetBtn"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center">
                        <i class="fa fa-refresh mr-1"></i> 重置
                    </button>
                </div>
            </form>

            <!-- 保存状态 -->
            <div id="wifi-status" class="mt-4 p-3 rounded-md hidden"></div>

            <!-- 连接进度 -->
            <div id="connect-progress" class="mt-4 hidden">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="connect-progress-bar" class="h-full bg-green-500 rounded-full progress-bar"
                         style="width: 0%"></div>
                </div>
                <p id="connect-progress-text" class="text-xs text-gray-500 mt-1">连接中...</p>
            </div>

            <!-- 设备信息卡片 -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden p-6 mt-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">设备信息</h2>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">设备名称:</span>
                        <span id="deviceName" class="font-medium text-gray-900">ESP8266-Config</span>
                    </div>
                    <div>
                        <span class="text-gray-500">MAC地址:</span>
                        <span id="deviceMac" class="font-medium text-gray-900 font-mono">--:--:--:--:--:--</span>
                    </div>
                    <div>
                        <span class="text-gray-500">配网模式:</span>
                        <span id="deviceMode" class="font-medium text-gray-900">AP模式</span>
                    </div>
                    <div>
                        <span class="text-gray-500">固件版本:</span>
                        <span id="firmwareVersion" class="font-medium text-gray-900">1.0.0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- DS18B20配置标签内容 -->
        <div id="ds18b20-content" class="tab-content p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-center text-blue-600">DS18B20 配置</h1>
            </div>

            <!-- 配置说明卡片 -->
            <div class="flash-card bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6 transition-all duration-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">传感器配置</h2>
                <p class="text-sm text-gray-600">
                    在此页面配置4路DS18B20温度传感器的输出引脚。选择每路传感器对应的GPIO引脚，点击保存按钮应用配置。
                    <span class="inline-flex items-center ml-2"><span class="status-indicator status-connected"></span>已连接</span>
                    <span class="inline-flex items-center ml-2"><span
                            class="status-indicator status-disconnected"></span>未连接</span>
                </p>
            </div>

            <!-- 传感器配置表格 -->
            <form id="configForm" class="space-y-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                        <tr>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">
                                传感器
                            </th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                设备地址
                            </th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                当前温度
                            </th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                连接状态
                            </th>
                            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">
                                输出引脚
                            </th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        <!-- 第一路传感器 -->
                        <tr class="sensor-row">
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">第一路</div>
                            </td>
                            <td class="px-4 py-4">
                                <div id="address-1" class="text-sm text-gray-600 font-mono break-all max-w-[120px]">--
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm text-gray-900">
                                    <span id="temp-1">--.-</span>
                                    <span class="text-gray-500">°C</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm" id="status-1">
                                    <span class="status-indicator status-disconnected"></span>
                                    <span>未连接</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <select name="output-1"
                                        class="form-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="5">GPIO5</option>
                                    <option value="13">GPIO13</option>
                                    <option value="12">GPIO12</option>
                                    <option value="14">GPIO14</option>
                                </select>
                            </td>
                        </tr>

                        <!-- 第二路传感器 -->
                        <tr class="sensor-row">
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">第二路</div>
                            </td>
                            <td class="px-4 py-4">
                                <div id="address-2" class="text-sm text-gray-600 font-mono break-all max-w-[120px]">--
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm text-gray-900">
                                    <span id="temp-2">--.-</span>
                                    <span class="text-gray-500">°C</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm" id="status-2">
                                    <span class="status-indicator status-disconnected"></span>
                                    <span>未连接</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <select name="output-2"
                                        class="form-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="5">GPIO5</option>
                                    <option value="13">GPIO13</option>
                                    <option value="12">GPIO12</option>
                                    <option value="14">GPIO14</option>
                                </select>
                            </td>
                        </tr>

                        <!-- 第三路传感器 -->
                        <tr class="sensor-row">
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">第三路</div>
                            </td>
                            <td class="px-4 py-4">
                                <div id="address-3" class="text-sm text-gray-600 font-mono break-all max-w-[120px]">--
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm text-gray-900">
                                    <span id="temp-3">--.-</span>
                                    <span class="text-gray-500">°C</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm" id="status-3">
                                    <span class="status-indicator status-disconnected"></span>
                                    <span>未连接</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <select name="output-3"
                                        class="form-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="5">GPIO5</option>
                                    <option value="13">GPIO13</option>
                                    <option value="12">GPIO12</option>
                                    <option value="14">GPIO14</option>
                                </select>
                            </td>
                        </tr>

                        <!-- 第四路传感器 -->
                        <tr class="sensor-row">
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">第四路</div>
                            </td>
                            <td class="px-4 py-4">
                                <div id="address-4" class="text-sm text-gray-600 font-mono break-all max-w-[120px]">--
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm text-gray-900">
                                    <span id="temp-4">--.-</span>
                                    <span class="text-gray-500">°C</span>
                                </div>
                            </td>
                            <td class="px-4 py-4">
                                <div class="text-sm" id="status-4">
                                    <span class="status-indicator status-disconnected"></span>
                                    <span>未连接</span>
                                </div>
                            </td>
                            <td class="px-4 py-4 rounded-br-lg">
                                <select name="output-4"
                                        class="form-select block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="5">GPIO5</option>
                                    <option value="13">GPIO13</option>
                                    <option value="12">GPIO12</option>
                                    <option value="14">GPIO14</option>
                                </select>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex space-x-4 pt-2">
                    <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                        <i class="fa fa-save mr-2"></i> 保存配置
                    </button>
                    <button type="button" id="refreshBtn"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md transition duration-200 flex items-center">
                        <i class="fa fa-refresh mr-1"></i> 刷新
                    </button>
                </div>
            </form>

            <!-- 保存状态 -->
            <div id="ds18b20-status" class="mt-4 p-3 rounded-md hidden"></div>

            <!-- 保存进度 -->
            <div id="save-progress" class="mt-4 hidden">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="save-progress-bar" class="h-full bg-green-500 rounded-full" style="width: 0%"></div>
                </div>
                <p id="save-progress-text" class="text-xs text-gray-500 mt-1">保存中...</p>
            </div>
        </div>

        <!-- 风扇配置标签内容 -->
        <div id="fan-content" class="tab-content p-6">
            <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">风扇速度控制器</h1>

            <!-- 主控制开关 -->
            <div class="control-card bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-8 transition-all duration-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-800">远程控制</h2>
                    <div class="relative inline-block w-12 h-6">
                        <input type="checkbox" id="control-toggle"
                               class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="control-toggle"
                               class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>
                <p id="control-status" class="text-sm text-gray-600 mt-2">控制已禁用，启用后可调节风扇速度</p>
            </div>

            <!-- 风扇控制区域 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- 风扇1控制 -->
                <div class="control-card bg-white border border-gray-200 rounded-lg p-4 transition-all duration-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-800">风扇 1</h3>
                        <span id="fan1-value" class="text-lg font-bold text-blue-600">0%</span>
                    </div>
                    <input type="range" id="fan1-slider" min="0" max="100" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           disabled>
                    <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="fan1-progress"
                             class="progress-bar h-full bg-gradient-to-r from-blue-400 to-indigo-600 rounded-full"
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- 风扇2控制 -->
                <div class="control-card bg-white border border-gray-200 rounded-lg p-4 transition-all duration-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-800">风扇 2</h3>
                        <span id="fan2-value" class="text-lg font-bold text-blue-600">0%</span>
                    </div>
                    <input type="range" id="fan2-slider" min="0" max="100" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           disabled>
                    <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="fan2-progress"
                             class="progress-bar h-full bg-gradient-to-r from-blue-400 to-indigo-600 rounded-full"
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- 风扇3控制 -->
                <div class="control-card bg-white border border-gray-200 rounded-lg p-4 transition-all duration-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-800">风扇 3</h3>
                        <span id="fan3-value" class="text-lg font-bold text-blue-600">0%</span>
                    </div>
                    <input type="range" id="fan3-slider" min="0" max="100" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           disabled>
                    <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="fan3-progress"
                             class="progress-bar h-full bg-gradient-to-r from-blue-400 to-indigo-600 rounded-full"
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- 风扇4控制 -->
                <div class="control-card bg-white border border-gray-200 rounded-lg p-4 transition-all duration-200">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-800">风扇 4</h3>
                        <span id="fan4-value" class="text-lg font-bold text-blue-600">0%</span>
                    </div>
                    <input type="range" id="fan4-slider" min="0" max="100" value="0"
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           disabled>
                    <div class="mt-2 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                        <div id="fan4-progress"
                             class="progress-bar h-full bg-gradient-to-r from-blue-400 to-indigo-600 rounded-full"
                             style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 批量控制按钮 -->
            <div class="mt-6">
                <button id="apply-all"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    应用所有设置
                </button>
            </div>

            <!-- 状态信息 -->
            <div id="fan-status" class="mt-6 p-3 rounded-md hidden"></div>
        </div>

        <!-- OTA更新标签内容 -->
        <div id="ota-content" class="tab-content p-6">
            <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">风扇控制器 OTA 更新</h1>

            <!-- 存储信息卡片 -->
            <div class="flash-card bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6 transition-all duration-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">存储状态</h2>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-500">芯片空间</p>
                        <p id="flash-total" class="text-xl font-bold text-blue-600">--</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">固件空间</p>
                        <p id="flash-used" class="text-xl font-bold text-orange-500">--</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">剩余空间</p>
                        <p id="flash-free" class="text-xl font-bold text-green-600">--</p>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="storage-progress"
                             class="h-full bg-gradient-to-r from-blue-400 to-indigo-600 rounded-full"
                             style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 上传表单 -->
            <form id="uploadForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择固件文件</label>
                    <input type="file" id="firmware" accept=".bin"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <button type="submit"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200">
                    上传并更新
                </button>
            </form>

            <!-- 上传进度 -->
            <div id="upload-progress" class="mt-6 hidden">
                <h3 class="text-sm font-medium text-gray-700 mb-1">上传进度</h3>
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-green-500 rounded-full" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-gray-500 mt-1">0%</p>
            </div>

            <!-- 状态信息 -->
            <div id="ota-status" class="mt-4 p-3 rounded-md hidden"></div>
        </div>

        <!-- 时钟/时间设置标签内容 -->
        <div id="time-content" class="tab-content p-6">
            <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">时钟/时间设置</h1>

            <!-- 时间状态卡片 -->
            <div class="flash-card bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-6 transition-all duration-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">当前时间</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500">设备时间</p>
                        <p id="device-time" class="text-xl font-bold text-blue-600">--:--:--</p>
                        <p id="device-date" class="text-sm text-gray-600">----年--月--日 星期--</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">时间源</p>
                        <p id="time-source" class="text-xl font-bold text-green-600">未同步</p>
                        <p class="text-sm text-gray-600">
                            <span class="status-indicator" id="time-status-indicator"></span>
                            <span id="time-status-text">等待同步</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- NTP服务器配置 -->
            <form id="ntpForm" class="space-y-6 mb-8">
                <div>
                    <label for="ntpServer" class="block text-sm font-medium text-gray-700 mb-1">NTP服务器</label>
                    <input type="text" id="ntpServer" name="ntpServer" value="pool.ntp.org"
                           class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <p class="mt-1 text-xs text-gray-500">常用NTP服务器: pool.ntp.org, cn.ntp.org.cn, ntp.aliyun.com</p>
                </div>

                <div>
                    <label for="timezone" class="block text-sm font-medium text-gray-700 mb-1">时区偏移 (小时)</label>
                    <input type="number" id="timezone" name="timezone" value="8" min="-12" max="12" step="0.5"
                           class="form-input block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <p class="mt-1 text-xs text-gray-500">例如: 中国为+8，UTC为0</p>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" id="syncNtpBtn"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                        <i class="fa fa-refresh mr-2"></i> NTP服务器对时
                    </button>
                    <button type="button" id="syncBrowserBtn"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 flex items-center justify-center">
                        <i class="fa fa-desktop mr-2"></i> 同步浏览器时间
                    </button>
                </div>
            </form>

            <!-- PCF8563状态 -->
            <div class="control-card bg-white border border-gray-200 rounded-lg p-4 transition-all duration-200">
                <h2 class="text-lg font-semibold text-gray-800 mb-3">PCF8563 实时时钟</h2>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-500">模块状态:</span>
                        <span id="pcf-status" class="font-medium text-gray-900">未检测到</span>
                    </div>
                    <div>
                        <span class="text-gray-500">最后同步时间:</span>
                        <span id="last-sync-time" class="font-medium text-gray-900">从未</span>
                    </div>
                </div>
            </div>

            <!-- 状态信息 -->
            <div id="time-status" class="mt-4 p-3 rounded-md hidden"></div>

            <!-- 同步进度 -->
            <div id="time-sync-progress" class="mt-4 hidden">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="time-sync-bar" class="h-full bg-green-500 rounded-full" style="width: 0%"></div>
                </div>
                <p id="time-sync-text" class="text-xs text-gray-500 mt-1">同步中...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 全局变量用于存储各标签页的定时器
    let timers = {
        wifi: null,
        ds18b20: null,
        fan: null,
        ota: null
    };

    // 标签切换功能
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // 添加当前标签的激活状态
            this.classList.add('active');
            const tabId = this.getAttribute('data-tab');
            document.getElementById(`${tabId}-content`).classList.add('active');

            // 停止所有定时器
            Object.values(timers).forEach(timer => {
                if (timer) clearInterval(timer);
            });

            // 根据当前标签页启动相应的定时器和初始化函数
            if (tabId === 'wifi') {
                initWifiPage();
            } else if (tabId === 'ds18b20') {
                initDs18b20Page();
            } else if (tabId === 'fan') {
                initFanPage();
            } else if (tabId === 'ota') {
                initOtaPage();
            }
        });
    });

    // 格式化字节大小
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // 显示状态消息的通用函数
    function showStatus(elementId, message, type) {
        const statusDiv = document.getElementById(elementId);
        statusDiv.textContent = message;

        // 设置状态样式
        if (type === 'error') {
            statusDiv.className = 'mt-4 p-3 rounded-md bg-red-100 text-red-700';
        } else if (type === 'success') {
            statusDiv.className = 'mt-4 p-3 rounded-md bg-green-100 text-green-700';
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-md bg-blue-100 text-blue-700';
        }

        statusDiv.classList.remove('hidden');

        // 3秒后自动隐藏（非错误消息）
        if (type !== 'error') {
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }
    }

    // WiFi配置页面功能
    function initWifiPage() {
        // 存储扫描到的网络
        let scannedNetworks = [];
        let selectedNetwork = null;

        // 获取设备信息
        fetchDeviceInfo();

        // 扫描WiFi网络
        function scanNetworks() {
            // 显示扫描状态
            showStatus('wifi-status', '正在扫描附近WiFi网络...', 'info');

            // 禁用扫描按钮并显示加载状态
            const scanBtn = document.getElementById('scanBtn');
            scanBtn.disabled = true;
            scanBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 扫描中...';

            // 清空网络列表
            document.getElementById('networksList').innerHTML = `
                <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                        <i class="fa fa-circle-o-notch fa-spin mr-2"></i>正在扫描WiFi网络...
                    </td>
                </tr>
            `;

            // 发送扫描请求
            fetch('/wifi-scan')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('扫描网络失败');
                    }
                    return response.json();
                })
                .then(networks => {
                    scannedNetworks = networks;
                    displayNetworks(networks);

                    // 恢复按钮状态
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = '<i class="fa fa-search mr-2"></i> 重新扫描WiFi网络';

                    showStatus('wifi-status', `已发现 ${networks.length} 个WiFi网络`, 'success');
                })
                .catch(error => {
                    console.error('扫描网络失败:', error);

                    // 恢复按钮状态
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = '<i class="fa fa-search mr-2"></i> 扫描附近WiFi网络';

                    document.getElementById('networksList').innerHTML = `
                        <tr>
                            <td colspan="3" class="px-4 py-8 text-center text-red-500">
                                <i class="fa fa-exclamation-triangle mr-2"></i>扫描失败，请重试
                            </td>
                        </tr>
                    `;

                    showStatus('wifi-status', '扫描网络失败，请重试', 'error');
                });
        }

        // 显示扫描到的网络
        function displayNetworks(networks) {
            const networksList = document.getElementById('networksList');

            if (networks.length === 0) {
                networksList.innerHTML = `
                    <tr>
                        <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                            <i class="fa fa-exclamation-circle mr-2"></i>未发现任何WiFi网络
                        </td>
                    </tr>
                `;
                return;
            }

            // 按信号强度排序（从强到弱）
            networks.sort((a, b) => b.rssi - a.rssi);

            let html = '';
            networks.forEach(network => {
                html += `
                <tr class="network-row cursor-pointer" data-ssid="${escapeHtml(network.ssid)}">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${escapeHtml(network.ssid)}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="signal-strength">
                            ${getSignalBars(network.rssi)}
                            <span class="ml-2 text-xs text-gray-500">${network.rssi} dBm</span>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm text-gray-600">
                            ${network.encryption ?
                                `<i class="fa fa-lock text-gray-500"></i> ${getEncryptionType(network.encryption)}` :
                                `<i class="fa fa-unlock text-gray-500"></i> 无加密`
                            }
                        </div>
                    </td>
                </tr>
                `;
            });

            networksList.innerHTML = html;

            // 为每个网络行添加点击事件
            document.querySelectorAll('.network-row').forEach(row => {
                row.addEventListener('click', function() {
                    // 移除其他行的选中状态
                    document.querySelectorAll('.network-row').forEach(r => {
                        r.classList.remove('selected');
                    });

                    // 添加当前行的选中状态
                    this.classList.add('selected');

                    // 获取选中的SSID
                    const ssid = this.getAttribute('data-ssid');
                    selectedNetwork = ssid;

                    // 更新输入框
                    document.getElementById('selectedSsid').value = ssid;
                    document.getElementById('networkConfig').classList.remove('hidden');

                    // 启用连接按钮
                    document.getElementById('connectBtn').disabled = false;
                });
            });
        }

        // 连接到选中的WiFi网络
        function connectToNetwork(ssid, password) {
            // 显示进度条
            const progressContainer = document.getElementById('connect-progress');
            const progressBar = document.getElementById('connect-progress-bar');
            const progressText = document.getElementById('connect-progress-text');

            progressContainer.classList.remove('hidden');
            progressBar.style.width = '20%';
            progressText.textContent = '正在保存配置...';

            // 禁用所有按钮
            disableAllButtons(true);

            // 发送连接请求
            fetch('/wifi-connect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    ssid: ssid,
                    password: password
                })
            })
            .then(response => {
                progressBar.style.width = '40%';
                progressText.textContent = '正在连接网络...';

                if (!response.ok) {
                    throw new Error('连接网络失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'connecting') {
                    // 定期检查连接状态
                    let checkCount = 0;
                    const maxChecks = 15; // 大约30秒

                    const checkConnection = setInterval(() => {
                        checkCount++;
                        const progress = 40 + (checkCount / maxChecks) * 50;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `正在连接网络...(${Math.round(progress)}%)`;

                        fetch('/wifi-connection-status')
                            .then(response => response.json())
                            .then(status => {
                                if (status.connected) {
                                    clearInterval(checkConnection);
                                    progressBar.style.width = '100%';
                                    progressText.textContent = '连接成功！正在重启设备...';
                                    showStatus('wifi-status', 'WiFi连接成功！设备将在几秒后重启', 'success');

                                    // 显示成功信息后，告知用户连接到新网络
                                    setTimeout(() => {
                                        // 请求获取设备新IP地址
                                        fetch('/wifi-success')
                                            .then(response => response.json())
                                            .then(data => {
                                                // 跳转到新IP的首页
                                                window.location.href = `http://${data.ip}/`;
                                            }).catch(error => {
                                                console.error('获取新IP地址失败:', error);
                                                // 失败时的备选跳转
                                                window.location.href = '/';
                                        });
                                    }, 3000);
                                } else if (checkCount >= maxChecks) {
                                    clearInterval(checkConnection);
                                    progressContainer.classList.add('hidden');
                                    progressBar.style.width = '0%';
                                    disableAllButtons(false);
                                    showStatus('wifi-status', '连接超时，请检查密码并重试', 'error');
                                }
                            })
                            .catch(error => {
                                clearInterval(checkConnection);
                                progressContainer.classList.add('hidden');
                                progressBar.style.width = '0%';
                                disableAllButtons(false);
                                showStatus('wifi-status', '检查连接状态失败', 'error');
                            });
                    }, 2000); // 每2秒检查一次
                }
            })
            .catch(error => {
                console.error('连接网络失败:', error);
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                disableAllButtons(false);
                showStatus('wifi-status', '连接网络失败: ' + error.message, 'error');
            });
        }

        // 禁用/启用所有按钮
        function disableAllButtons(disable) {
            document.getElementById('scanBtn').disabled = disable;
            document.getElementById('connectBtn').disabled = disable || !selectedNetwork;
            document.getElementById('resetBtn').disabled = disable;
        }

        // 重置表单
        function resetForm() {
            document.getElementById('wifiForm').reset();
            document.getElementById('networkConfig').classList.add('hidden');
            document.getElementById('connectBtn').disabled = true;

            // 移除选中状态
            document.querySelectorAll('.network-row').forEach(row => {
                row.classList.remove('selected');
            });

            selectedNetwork = null;
            showStatus('wifi-status', '表单已重置', 'info');
        }

        // 获取信号强度图标
        function getSignalBars(rssi) {
            // RSSI值通常在-30（最强）到-100（最弱）之间
            let bars = 0;

            if (rssi >= -50) bars = 4;      // 最强
            else if (rssi >= -65) bars = 3; // 强
            else if (rssi >= -75) bars = 2; // 中
            else if (rssi >= -85) bars = 1; // 弱
            else bars = 0;                  // 极弱

            let html = '';
            for (let i = 1; i <= 4; i++) {
                const height = 4 + (i * 3);
                const opacity = i <= bars ? 1 : 0.3;
                html += `<div class="signal-bar" style="height: ${height}px; opacity: ${opacity}"></div>`;
            }

            return html;
        }

        // 获取加密类型文本
        function getEncryptionType(encryption) {
            const types = {
                'WEP': 'WEP',
                'WPA': 'WPA',
                'WPA2': 'WPA2',
                'WPA3': 'WPA3',
                'WPA2/WPA3': 'WPA2/WPA3'
            };

            return types[encryption] || encryption;
        }

        // HTML转义函数，防止XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 获取设备信息
        function fetchDeviceInfo() {
            fetch('/wifi-device-info')
                .then(response => response.json())
                .then(info => {
                    document.getElementById('deviceName').textContent = info.name || 'ESP8266-Config';
                    document.getElementById('deviceMac').textContent = info.mac || '--:--:--:--:--:--';
                    document.getElementById('firmwareVersion').textContent = info.version || '未知';
                    // 新增：显示工作模式
                    document.getElementById('deviceMode').textContent = formatMode(info.mode) || '未知';

                    // 更新设备状态
                    const statusElement = document.getElementById('device-status');
                    if (info.connected) {
                        statusElement.innerHTML = '<span class="status-indicator status-connected"></span><span>已连接</span>';
                    } else {
                        statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span><span>未连接</span>';
                    }
                }
            ).catch(error => {
                console.error('获取设备信息失败:', error);
            });
        }

        // 新增：格式化模式显示文本
        function formatMode(mode) {
            const modeMap = {
                'WIFI_STA': '客户端模式',
                'WIFI_AP': '接入点模式',
                'WIFI_AP_STA': '混合模式'
            };
            return modeMap[mode] || mode;
        }

        // 绑定事件
        document.getElementById('scanBtn').addEventListener('click', scanNetworks);

        document.getElementById('wifiForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (selectedNetwork) {
                const password = document.getElementById('wifiPassword').value;
                connectToNetwork(selectedNetwork, password);
            }
        });

        document.getElementById('resetBtn').addEventListener('click', resetForm);

        // 设置定时器定期获取设备信息
        timers.wifi = setInterval(fetchDeviceInfo, 10000);
    }

    // DS18B20配置页面功能
    function initDs18b20Page() {
        // 获取传感器配置信息
        function fetchSensorData() {
            fetch('/ds18b20-data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应不正常');
                    }
                    return response.json();
                })
                .then(data => {
                    // 更新每个传感器的数据
                    for (let i = 0; i < 4; i++) {
                        const sensor = data[i] || {};
                        const index = i + 1; // 传感器ID从1开始

                        // 更新地址
                        document.getElementById(`address-${index}`).textContent =
                            sensor.address || '未检测到';

                        // 更新温度
                        const tempElement = document.getElementById(`temp-${index}`);
                        if (sensor.temperature !== undefined && sensor.temperature !== -255) {
                            tempElement.textContent = sensor.temperature.toFixed(1);
                            tempElement.classList.remove('text-gray-400');
                        } else {
                            tempElement.textContent = '--.-';
                            tempElement.classList.add('text-gray-400');
                        }

                        // 更新连接状态
                        const statusElement = document.getElementById(`status-${index}`);
                        if (sensor.connected) {
                            statusElement.innerHTML = '<span class="status-indicator status-connected"></span><span>已连接</span>';
                            statusElement.classList.add('text-green-600');
                            statusElement.classList.remove('text-red-600');
                        } else {
                            statusElement.innerHTML = '<span class="status-indicator status-disconnected"></span><span>未连接</span>';
                            statusElement.classList.add('text-red-600');
                            statusElement.classList.remove('text-green-600');
                        }

                        // 设置选中的GPIO
                        if (sensor.outputPin) {
                            const selectElement = document.querySelector(`select[name="output-${index}"]`);
                            if (selectElement && selectElement.value !== sensor.outputPin) {
                                selectElement.value = sensor.outputPin;
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('获取传感器数据失败:', error);
                    showStatus('ds18b20-status', '获取传感器数据失败', 'error');
                });
        }

        // 保存配置
        function saveConfiguration() {
            const formData = new FormData(document.getElementById('configForm'));
            const configData = {};

            // 收集表单数据
            formData.forEach((value, key) => {
                configData[key] = value;
            });

            // 显示进度条
            const progressContainer = document.getElementById('save-progress');
            const progressBar = document.getElementById('save-progress-bar');

            progressContainer.classList.remove('hidden');
            progressBar.style.width = '30%';

            // 发送配置数据
            fetch('/ds18b20-save-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(configData)
            })
            .then(response => {
                progressBar.style.width = '70%';
                if (!response.ok) {
                    throw new Error('保存配置失败');
                }
                return response.text();
            })
            .then(data => {
                progressBar.style.width = '100%';
                showStatus('ds18b20-status', '配置保存成功', 'success');

                // 延迟隐藏进度条并刷新数据
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                    fetchSensorData();
                }, 1000);
            })
            .catch(error => {
                console.error('保存配置失败:', error);
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
                showStatus('ds18b20-status', '保存配置失败: ' + error.message, 'error');
            });
        }

        // 绑定事件
        document.getElementById('configForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveConfiguration();
        });

        document.getElementById('refreshBtn').addEventListener('click', function() {
            // 添加旋转动画
            this.querySelector('i').classList.add('fa-spin');
            fetchSensorData().finally(() => {
                // 移除旋转动画
                this.querySelector('i').classList.remove('fa-spin');
                showStatus('ds18b20-status', '数据已刷新', 'success');
            });
        });

        // 首次加载数据
        fetchSensorData();

        // 设置定时器定期刷新数据
        timers.ds18b20 = setInterval(fetchSensorData, 5000);
    }

    // 风扇配置页面功能
    function initFanPage() {
        // 获取DOM元素
        const controlToggle = document.getElementById('control-toggle');
        const controlStatus = document.getElementById('control-status');
        const applyAllBtn = document.getElementById('apply-all');
        const sliders = {
            1: document.getElementById('fan1-slider'),
            2: document.getElementById('fan2-slider'),
            3: document.getElementById('fan3-slider'),
            4: document.getElementById('fan4-slider')
        };
        const values = {
            1: document.getElementById('fan1-value'),
            2: document.getElementById('fan2-value'),
            3: document.getElementById('fan3-value'),
            4: document.getElementById('fan4-value')
        };
        const progressBars = {
            1: document.getElementById('fan1-progress'),
            2: document.getElementById('fan2-progress'),
            3: document.getElementById('fan3-progress'),
            4: document.getElementById('fan4-progress')
        };

        // 状态变量
        let controlEnabled = false;
        let currentSpeeds = {1: 0, 2: 0, 3: 0, 4: 0};
        let updateTimers = {};

        // 更新控制状态
        function updateControlState(enabled) {
            controlEnabled = enabled;

            // 更新UI
            controlStatus.textContent = enabled ? '控制已启用，可以调节风扇速度' : '控制已禁用，启用后可调节风扇速度';
            applyAllBtn.disabled = !enabled;

            // 更新滑块状态
            for (let i = 1; i <= 4; i++) {
                sliders[i].disabled = !enabled;
                sliders[i].className = enabled
                    ? 'w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500'
                    : 'w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-not-allowed opacity-50';
            }

            // 只有状态变化时才发送请求到服务器
            fetch('/fun-control-state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ enabled: enabled })
            }).catch(error => console.error('更新控制状态失败:', error));
        }

        // 应用所有风扇速度设置
        function applyAllSpeeds() {
            if (!controlEnabled) return;

            // 显示状态
            showStatus('fan-status', '正在应用所有设置...', 'info');

            // 发送所有风扇速度到服务器
            fetch('/fun-control-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fan1: currentSpeeds[1],
                    fan2: currentSpeeds[2],
                    fan3: currentSpeeds[3],
                    fan4: currentSpeeds[4]
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('应用设置失败');
                }
                showStatus('fan-status', '所有设置已应用', 'success');
            })
            .catch(error => {
                console.error('应用设置失败:', error);
                showStatus('fan-status', '应用设置失败: ' + error.message, 'error');
            });
        }

        // 更新风扇速度显示
        function updateFanDisplay(fanId, value) {
            values[fanId].textContent = `${value}%`;
            progressBars[fanId].style.width = `${value}%`;
            sliders[fanId].value = value;
            currentSpeeds[fanId] = value;
        }

        // 实时更新单个风扇速度到服务器
        function updateFanSpeedToServer(fanId, speed) {
            if (!controlEnabled) return;

            // 使用防抖机制，避免过于频繁的请求
            if (updateTimers[fanId]) {
                clearTimeout(updateTimers[fanId]);
            }

            updateTimers[fanId] = setTimeout(() => {
                const data = { [`fan${fanId}`]: speed };

                fetch('/fun-control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('更新风扇速度失败');
                    }
                    showStatus('fan-status', `风扇 ${fanId} 速度已更新为 ${speed}%`, 'success');
                })
                .catch(error => {
                    console.error(`更新风扇 ${fanId} 速度失败:`, error);
                    showStatus('fan-status', `更新风扇 ${fanId} 速度失败`, 'error');
                });
            }, 500); // 500ms防抖
        }

        // 从服务器获取当前风扇状态
        function fetchFanStates() {
            fetch('/fun-control-states')
                .then(response => response.json())
                .then(data => {
                    // 更新控制状态
                    if (data.enabled !== undefined && data.enabled !== controlEnabled) {
                        controlToggle.checked = data.enabled;
                        updateControlState(data.enabled);
                    }

                    // 更新各个风扇速度
                    for (let i = 1; i <= 4; i++) {
                        if (data[`fan${i}`] !== undefined && currentSpeeds[i] !== data[`fan${i}`]) {
                            updateFanDisplay(i, data[`fan${i}`]);
                        }
                    }
                })
                .catch(error => console.error('获取风扇状态失败:', error));
        }

        // 事件监听 - 控制开关
        controlToggle.addEventListener('change', function() {
            updateControlState(this.checked);
        });

        // 事件监听 - 批量应用按钮
        applyAllBtn.addEventListener('click', applyAllSpeeds);

        // 事件监听 - 滑块变化（实时更新）
        for (let i = 1; i <= 4; i++) {
            sliders[i].addEventListener('input', function() {
                // 实时更新显示
                const value = this.value;
                updateFanDisplay(i, value);
                // 实时更新到服务器（带防抖）
                updateFanSpeedToServer(i, value);
            });
        }

        // 首次加载状态
        fetchFanStates();

        // 设置定时器定期获取状态
        timers.fan = setInterval(fetchFanStates, 5000);
    }

    // OTA更新页面功能
    function initOtaPage() {
        // 获取存储信息
        function fetchStorageInfo() {
            fetch('/ota-storage-info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('flash-total').textContent = formatBytes(data.total);
                    document.getElementById('flash-used').textContent = formatBytes(data.used);
                    document.getElementById('flash-free').textContent = formatBytes(data.free);

                    // 计算并更新进度条
                    const usedPercent = (data.used / data.total) * 100;
                    document.getElementById('storage-progress').style.width = `${usedPercent}%`;
                })
                .catch(error => {
                    console.error('获取存储信息失败:', error);
                    showStatus('ota-status', '获取存储信息失败', 'error');
                });
        }

        // 处理文件上传
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('firmware');
            if (!fileInput.files || fileInput.files.length === 0) {
                showStatus('ota-status', '请选择一个固件文件', 'error');
                return;
            }

            const file = fileInput.files[0];
            if (file.type !== 'application/octet-stream' && !file.name.endsWith('.bin')) {
                showStatus('ota-status', '请选择.bin格式的固件文件', 'error');
                return;
            }

            // 显示上传进度
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = '0%';

            // 创建FormData
            const formData = new FormData();
            formData.append('firmware', file);

            // 创建XMLHttpRequest以跟踪进度
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/ota-update', true);

            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressBar.style.width = `${percent}%`;
                    progressText.textContent = `${Math.round(percent)}%`;
                }
            });

            xhr.onload = function() {
                if (xhr.status === 200) {
                    // 显示更新成功提示
                    showStatus('ota-status', '固件更新成功！2秒后将自动刷新页面...', 'success');

                    // 隐藏进度条
                    document.getElementById('upload-progress').classList.add('hidden');

                    // 2秒后刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    showStatus('ota-status', '错误: ' + xhr.responseText, 'error');
                }
            };

            xhr.addEventListener('error', function() {
                showStatus('ota-status', '网络错误，更新失败', 'error');
                progressContainer.classList.add('hidden');
            });

            xhr.send(formData);
        });

        // 首次加载存储信息
        fetchStorageInfo();

        // 设置定时器定期刷新存储信息
        timers.ota = setInterval(fetchStorageInfo, 10000);
    }

    // 时钟页面初始化
function initTimePage() {
    // 立即获取一次时间
    fetchCurrentTime();

    // 定时刷新时间（每秒钟）
    timers.time = setInterval(fetchCurrentTime, 1000);

    // NTP服务器对时表单提交
    document.getElementById('ntpForm').addEventListener('submit', function(e) {
        e.preventDefault();
        syncWithNtp();
    });

    // 同步浏览器时间按钮
    document.getElementById('syncBrowserBtn').addEventListener('click', syncWithBrowserTime);
}

// 获取当前设备时间
function fetchCurrentTime() {
    fetch('/current-time')
        .then(response => {
            if (!response.ok) {
                throw new Error('获取时间失败');
            }
            return response.json();
        })
        .then(data => {
            // 更新设备时间显示
            document.getElementById('device-time').textContent = data.time;
            document.getElementById('device-date').textContent = data.date;

            // 更新时间源信息
            document.getElementById('time-source').textContent = data.source;

            // 更新状态指示器
            const indicator = document.getElementById('time-status-indicator');
            const statusText = document.getElementById('time-status-text');

            if (data.source === 'PCF8563') {
                indicator.className = 'status-indicator status-connected';
                statusText.textContent = '已同步 (RTC)';
                document.getElementById('pcf-status').textContent = '正常工作';
                document.getElementById('last-sync-time').textContent = data.syncTime || '未知';
            } else if (data.source === 'NTP') {
                indicator.className = 'status-indicator status-connected';
                statusText.textContent = '已同步 (NTP)';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                statusText.textContent = '未同步';
            }
        })
        .catch(error => {
            console.error('获取时间失败:', error);
        });
}

// 使用NTP服务器对时
function syncWithNtp() {
    const ntpServer = document.getElementById('ntpServer').value;
    const timezone = document.getElementById('timezone').value;

    // 显示进度条
    const progressContainer = document.getElementById('time-sync-progress');
    const progressBar = document.getElementById('time-sync-bar');
    const progressText = document.getElementById('time-sync-text');

    progressContainer.classList.remove('hidden');
    progressBar.style.width = '30%';
    progressText.textContent = '正在连接NTP服务器...';

    // 发送NTP同步请求
    fetch('/sync-ntp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            server: ntpServer,
            timezone: parseFloat(timezone)
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('NTP同步失败');
        }
        return response.json();
    })
    .then(data => {
        progressBar.style.width = '70%';
        progressText.textContent = '正在更新RTC时钟...';

        if (data.success) {
            setTimeout(() => {
                progressBar.style.width = '100%';
                progressText.textContent = '同步完成';
                showStatus('time-status', '时间同步成功', 'success');

                // 3秒后隐藏进度条
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 1000);
            }, 1000);
        } else {
            throw new Error(data.message || 'NTP同步失败');
        }
    })
    .catch(error => {
        progressContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        showStatus('time-status', '同步失败: ' + error.message, 'error');
    });
}

// 同步浏览器时间
function syncWithBrowserTime() {
    // 获取浏览器当前时间
    const now = new Date();

    // 显示进度条
    const progressContainer = document.getElementById('time-sync-progress');
    const progressBar = document.getElementById('time-sync-bar');
    const progressText = document.getElementById('time-sync-text');

    progressContainer.classList.remove('hidden');
    progressBar.style.width = '50%';
    progressText.textContent = '正在设置时间...';

    // 构建时间数据
    const timeData = {
        year: now.getFullYear(),
        month: now.getMonth() + 1,  // 月份从0开始，所以加1
        day: now.getDate(),
        hour: now.getHours(),
        minute: now.getMinutes(),
        second: now.getSeconds(),
        weekday: now.getDay() || 7   // 转换为1-7表示星期几
    };

    // 发送时间设置请求
    fetch('/set-time', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(timeData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('设置时间失败');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            progressText.textContent = '设置完成';
            showStatus('time-status', '已成功同步浏览器时间', 'success');

            // 3秒后隐藏进度条
            setTimeout(() => {
                progressContainer.classList.add('hidden');
                progressBar.style.width = '0%';
            }, 1000);
        } else {
            throw new Error('设置时间失败');
        }
    })
    .catch(error => {
        progressContainer.classList.add('hidden');
        progressBar.style.width = '0%';
        showStatus('time-status', '设置失败: ' + error.message, 'error');
    });
}

    // 初始化默认页面
    document.addEventListener('DOMContentLoaded', () => {
        initWifiPage();
    });
</script>
</body>
</html>